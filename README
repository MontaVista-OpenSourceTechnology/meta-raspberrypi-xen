This README file contains information on the contents of the
meta-raspberry-pi-xen layer.

Please see the corresponding sections below for details.

Dependencies
============

  URI: git://git.yoctoproject.org/poky
  branch: dunfell
 
  URI: git://git.yoctoproject.org/meta-virtualization
  branch: dunfell

  URI: git://git.yoctoproject.org/meta-raspberrypi
  branch: dunfell

Patches
=======

Please submit any patches against the meta-raspberry-pi-xen layer to
the maintainer:

Maintainer: Corey Minyard <cminyard@mvista.com>

Table of Contents
=================

  I. Adding the meta-raspberry-pi-xen layer to your build
 II. Misc


I. Adding the meta-raspberry-pi-xen layer to your build
=================================================

The easiest way to use this layer is to use the MontaVista OpenCGX
releases.  Go to
https://github.com/MontaVista-OpenSourceTechnology/opencgx-rasberrypi
and follow the instructions for installation.

Then get this layer via git and add it to bblayers

  git clone https://github.com/MontaVista-OpenSourceTechnology/meta-raspberrypi-xen.git ../layers/meta-raspberrypi-xen
  (cd $TOPDIR/layers/meta-raspberrypi-xen; git checkout dunfell)
  bitbake-layers add-layer $TOPDIR/layers/meta-raspberrypi-xen`

Add the following to your local.conf:

  MACHINE = "raspberrypi4-64-xen"
  IMAGE_FSTYPES = "tar.xz ext3 rpi-sdimg"

plus whatever else you need and build away:

  bitbake <imagename>

Where <imagename> is the image you want to build, like core-image-minimal or
whatever.  Then put in your microsd card, unmount any directories that get
mounted from it, and do the following command:

  sudo dd if=tmp/deploy/images/raspberrypi4-64-xen/<imagename>-raspberrypi4-64-xen.rpi-sdimg of=/dev/mmcblk0 bs=1M

If you want, you can resize the root filesystem to take the entire mmc
device.  To do that, use fdisk to make the second partition bigger, and
use resize2fs to resize the filesystem.  Somethingg like:

  $ sudo fdisk /dev/mmcblk0
  Welcome to fdisk (util-linux 2.31.1).
  Changes will remain in memory only, until you decide to write them.
  Be careful before using the write command.

  Command (m for help): p
  Disk /dev/mmcblk0: 58.5 GiB, 62851645440 bytes, 122757120 sectors
  Units: sectors of 1 * 512 = 512 bytes
  Sector size (logical/physical): 512 bytes / 512 bytes
  I/O size (minimum/optimal): 512 bytes / 512 bytes
  Disklabel type: dos
  Disk identifier: 0x33b29282

  Device         Boot Start     End Sectors  Size Id Type
  /dev/mmcblk0p1 *     8192   90111   81920   40M  c W95 FAT32 (LBA)
  /dev/mmcblk0p2      90112 1433599 1343488  656M 83 Linux

  Command (m for help): d
  Partition number (1,2, default 2): 2

  Partition 2 has been deleted.

  Command (m for help): n
  Partition type
     p   primary (1 primary, 0 extended, 3 free)
     e   extended (container for logical partitions)
  Select (default p): p
  Partition number (2-4, default 2): 
  First sector (2048-122757119, default 2048): 90112
  Last sector, +sectors or +size{K,M,G,T,P} (90112-122757119, default 122757119): 

  Created a new partition 2 of type 'Linux' and of size 58.5 GiB.
  Partition #2 contains a ext3 signature.

  Do you want to remove the signature? [Y]es/[N]o: n

  Command (m for help): w

  The partition table has been altered.
  Calling ioctl() to re-read partition table.
  Syncing disks.

  $ sudo resize2fs /dev/mmcblk0p2 
  resize2fs 1.44.1 (24-Mar-2018)
  Resizing the filesystem on /dev/mmcblk0p2 to 15333376 (4k) blocks.
  The filesystem on /dev/mmcblk0p2 is now 15333376 (4k) blocks long.

  $ sync

Then remove the mmc, put it in your Pi and boot on the serial console.

II. Misc
========

Due to issues with some Raspberry Pi devices not supporting DMA above 1GB and
Xen not understanding this, the memory is limited to 1GB.

Note that only the serial console is currently supported.  So you must have a
compatible serial interface.  I use the TTL-232R-RPi (you can search on Mouser,
DigiKey, or whatever for it).  Be careful with getting the pins right, make
sure to look for the square pad (pin 1) for reference.  Sometime vendors are
showing the bottom of the board.

The standard MontaVista tools will not automatically update this particular
repository added this way.  If you need to update, you will need to cd to
$TOPDIR/layers/meta-raspberrypi-xen and do a "git pull".  This will be better
integrated in the future.
